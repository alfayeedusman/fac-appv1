[build]
  # Build command: install dependencies and build both client and server
  # Using --legacy-peer-deps to avoid dependency conflicts
  command = "npm ci --legacy-peer-deps --include=dev --prefer-offline --no-audit && npm run build && npm run build:server"
  functions = "netlify/functions"
  publish = "dist/spa"
  base = "/"

[build.environment]
  # Node version: LTS for maximum Netlify compatibility
  NODE_VERSION = "20"
  # Ensure devDependencies (vite, typescript, etc.) are installed during build.
  # Netlify sets NODE_ENV=production during builds, which can cause npm to omit dev deps unless overridden.
  NPM_CONFIG_PRODUCTION = "false"
  # Helps prevent build-time out-of-memory crashes during Vite bundling on CI.
  NODE_OPTIONS = "--max_old_space_size=4096"
  NODE_ENV = "production"
  # Netlify secret scanner can mistake Firebase Web API keys (AIza...) as secrets.
  # Firebase Web API keys are expected to be public in the built frontend bundle.
  SECRETS_SCAN_SMART_DETECTION_OMIT_VALUES = "AIzaSyAaH10Jpspj7t2N4QeVXmfwJYubb0LwkkM"

# Environment variables - REQUIRED TO BE SET IN NETLIFY DASHBOARD
# Go to: Site Settings → Build & Deploy → Environment
# Add all variables below with their values
#
# Required variables:
# - NEON_DATABASE_URL: PostgreSQL connection string from Neon
# - DATABASE_URL: (same as NEON_DATABASE_URL)
# - VITE_FIREBASE_API_KEY: Firebase API key
# - VITE_FIREBASE_AUTH_DOMAIN: Firebase auth domain
# - VITE_FIREBASE_PROJECT_ID: Firebase project ID
# - VITE_FIREBASE_STORAGE_BUCKET: Firebase storage bucket
# - VITE_FIREBASE_MESSAGING_SENDER_ID: Firebase messaging sender ID
# - VITE_FIREBASE_APP_ID: Firebase app ID
# - VITE_FIREBASE_MEASUREMENT_ID: Firebase measurement ID
# - VITE_MAPBOX_TOKEN: Mapbox API token
# - VITE_PUSHER_KEY: Pusher public key
# - VITE_PUSHER_CLUSTER: Pusher cluster (e.g., "ap1")
# - PUSHER_KEY: Pusher key (backend)
# - PUSHER_SECRET: Pusher secret (backend)
# - PUSHER_APP_ID: Pusher app ID (backend)
# - PUSHER_CLUSTER: Pusher cluster (backend)
# - XENDIT_SECRET_KEY: Xendit secret key (backend)
# - XENDIT_PUBLIC_KEY: Xendit public key
# - XENDIT_WEBHOOK_TOKEN: Xendit webhook token
# - VITE_FIREBASE_FCM_KEY: Firebase FCM public key

[context.production]
  environment = { NODE_ENV = "production" }

[functions]
  external_node_modules = ["express", "cors", "drizzle-orm", "@neondatabase/serverless"]
  node_bundler = "esbuild"

# API Redirect (MUST come before catch-all SPA redirect)
[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/api/:splat"
  status = 200
  force = true

# Payment Callback Routes (Xendit redirects) - Explicit SPA routes
[[redirects]]
  from = "/booking-success"
  to = "/index.html"
  status = 200

[[redirects]]
  from = "/booking-failed"
  to = "/index.html"
  status = 200

[[redirects]]
  from = "/booking-success?*"
  to = "/index.html"
  status = 200

[[redirects]]
  from = "/booking-failed?*"
  to = "/index.html"
  status = 200

# SPA Catch-all Redirect (MUST come after specific redirects)
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

# HTTP headers for caching strategy
[[headers]]
  for = "/index.html"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"

[[headers]]
  for = "/*.js"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# API Headers - Ensure proper CORS and security headers
[[headers]]
  for = "/api/*"
  [headers.values]
    Access-Control-Allow-Origin = "*"
    Access-Control-Allow-Methods = "GET, POST, PUT, DELETE, OPTIONS, PATCH"
    Access-Control-Allow-Headers = "Content-Type, Authorization"
    X-Content-Type-Options = "nosniff"
    X-Frame-Options = "SAMEORIGIN"
